name: Upload Haloarmory to Discord

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch: 

jobs:
  zip-n-push:
    name: Zip and Push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@master
      - name: Zip Folder
        run: |
          cd ../
          cp -vr HaloArmory-CharPersistence character-persistence-v${{ github.run_number }}
          rm -rf "HaloArmory-CharPersistence/Character-Persistence_V${{ github.run_number }}.zip"
          zip -r "HaloArmory-CharPersistence/Character-Persistence_V${{ github.run_number }}.zip" ./character-persistence-v${{ github.run_number }} -x "haloarmory-v${{ github.run_number }}/.git/*" "haloarmory-v${{ github.run_number }}/.github/*" "haloarmory-v${{ github.run_number }}/README.md"
      - name: Create Changelog
        id: changelog
        uses: actions/github-script@v6.3.1
        env:
          COMMITS: ${{ toJSON(github.event.commits) }}
        with:
          result-encoding: string
          script: |
              const commits = JSON.parse(process.env.COMMITS);
              var lines = "";
              for (const commit of commits) {
                lines += "```" + commit.message + "```"
              }
              return lines
      - name: Send Discord Update
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          content: |
            ## **HALOARMORY** has been updated to version ${{ github.run_number }}!
            Changelog:
            ${{ steps.changelog.outputs.result }}
            Download:
          filename: "./Character-Persistence_V${{ github.run_number }}.zip"
